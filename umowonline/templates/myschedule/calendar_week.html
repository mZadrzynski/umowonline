{% extends "myschedule/calendar_sidemenu.html" %}
{% block title %}Kalendarz tygodniowy{% endblock %}
{% block calendar %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/calendar.css' %}">

<div class="calendar-container">
    <div">
        <h2>Kalendarz tygodniowy użytkownika {{ request.user.username }}</h2>
        <div class="month-nav">
            <a href="?week={{ week_offset|add:-1 }}">
                « Poprzedni tydzień
            </a>
            <span>{{ selected_week|date:"d.m.Y" }}</span>
            <a href="?week={{ week_offset|add:1 }}">
                Następny tydzień »
            </a>
        </div>
    </div>

    <table class="calendar-table">
        <thead>
            <tr>
                <th>Pon</th>
                <th>Wt</th>
                <th>Śr</th>
                <th>Cz</th>
                <th>Pt</th>
                <th>Sob</th>
                <th>Nd</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                {% for day, availabilities in availabilities_by_day_items %}
                <td class="calendar-cell">
                    <div class="cell-content">
                        <div class="calendar-day">
                            {{ day|date:"d" }}
                        </div>
                        
                        {% if availabilities %}
                            {% for info in availabilities %}
                            <div class="availability-item">
                                <div class="availability-title">
                                    {% if info.availability.title %}
                                        {{ info.availability.title }}
                                    {% else %}
                                        Dostępność
                                    {% endif %}
                                    <a href="{% url 'delete_availability' info.availability.id %}" 
                                       class="btn-outline-danger"
                                       title="Usuń dostępność" 
                                       onclick="return confirm('Czy na pewno chcesz usunąć tę dostępność?')"
                                       style="float: right; color: #dc3545; text-decoration: none;">
                                        🗑️
                                    </a>
                                </div>
                                <div class="availability-time">
                                    {{ info.availability.start_time|time:"H:i" }} - {{ info.availability.end_time|time:"H:i" }}
                                </div>

                                <!-- Zarezerwowane wizyty z szczegółami -->
                {% if info.bookings %}
<div class="booked-visits" style="margin-top: 8px;">
    <small><strong>Zarezerwowane wizyty:</strong></small>
    {% for booking in info.bookings %}
    <div class="visit-item" style="background: #f8f9fa; margin: 4px 0; padding: 6px; border-radius: 4px; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <strong style="color: #495057;">{{ booking.service_type.name }}</strong><br>
                
                <span style="color: #6c757d;">
                    🕐 {{ booking.start_datetime|time:"H:i" }}-{{ booking.end_datetime|time:"H:i" }}
                </span><br>
                
                <span style="color: #28a745;">
                    👤 
                    {% if booking.client_name %}
                        {{ booking.client_name }}
                    {% elif booking.user %}
                        {{ booking.user.username }}
                    {% else %}
                        [Brak nazwy]
                    {% endif %}
                </span>
                
                {% if booking.client_phone %}
                    <br><span style="color: #17a2b8;">📞 {{ booking.client_phone }}</span>
                {% endif %}
                
                {% if booking.client_note %}
                    <br><span style="color: #ffc107;">💬 {{ booking.client_note }}</span>
                {% endif %}
            </div>
            
            <a href="{% url 'cancel_calendar_booking' booking.id %}" 
               title="Anuluj wizytę" 
               style="color: #dc3545; text-decoration: none;" 
               onclick="return confirm('Czy na pewno chcesz anulować tę wizytę?')">
                ❌
            </a>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

                               <!-- Przycisk rezerwacji -->
                                <div class="booking-actions">
                                    
                                    {% if request.user.calendar == info.availability.calendar %}
                                        <!-- Właściciel kalendarza -->
                                        <a href="{% url 'book_availability' info.availability.id %}" 
                                        class="book-link owner">
                                            👤 Dodaj wizytę klienta
                                        </a>
                                    {% else %}
                                        <!-- Zwykły użytkownik -->
                                        {% if info.availability.date > today or info.availability.date == today and info.availability.start_time >= now_time %}
                                            <a href="{% url 'book_availability' info.availability.id %}" 
                                            class="book-link available">
                                                📅 Zarezerwuj wizytę
                                            </a>
                                        {% else %}
                                            <span class="book-link past" style="background-color: #6c757d; color: #fff; cursor: not-allowed;">
                                                ⏰ Termin minął
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-availability">
                                Brak dostępności
                            </div>
                        {% endif %}
                    </div>
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>

    <div class="share-section">
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h4>Udostępnij kalendarz</h4>
                <p>Udostępnij swój kalendarz innym, kopiując poniższy adres:</p>
                <div class="input-group">
                    <input type="text" 
                           class="form-control share-input" 
                           readonly 
                           value="{{ public_calendar_url }}"
                           id="calendar-url">
                    <button class="btn btn-outline-secondary copy-btn" 
                            type="button" 
                            onclick="copyToClipboard()">
                        Kopiuj
                    </button>
                </div>
            </div>

            <div style="flex: 1;">
                <h4>Twoja dostępność w tym tygodniu:</h4>
                <ul class="ul_week">
                    {% for day, availabilities in availabilities_by_day_items %}
                        {% for info in availabilities %}
                        <li style="margin-bottom: 8px;">
                            {{ day|date:"d.m.Y" }}: {{ info.availability.start_time }} - {{ info.availability.end_time }}
                            <a href="{% url 'delete_availability' info.availability.id %}" 
                               class="btn btn-sm btn-outline-danger"
                               style="margin-left: 8px; font-size: 12px; padding: 2px 6px;"
                               onclick="return confirm('Czy na pewno chcesz usunąć tę dostępność?')">
                                🗑️
                            </a>
                        </li>
                        {% endfor %}
                    {% empty %}
                    <li>Brak dostępności</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard() {
    const input = document.getElementById('calendar-url');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'Skopiowano!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>

{% endblock %}