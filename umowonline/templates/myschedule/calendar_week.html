{% extends "myschedule/calendar_sidemenu.html" %}
{% block title %}Kalendarz tygodniowy{% endblock %}
{% block calendar %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/calendar.css' %}">

<div class="calendar-container">
    <div">
        <h2>Kalendarz tygodniowy u≈ºytkownika {{ request.user.username }}</h2>
        <div class="month-nav">
            <a href="?week={{ week_offset|add:-1 }}">
                ¬´ Poprzedni tydzie≈Ñ
            </a>
            <span>{{ selected_week|date:"d.m.Y" }}</span>
            <a href="?week={{ week_offset|add:1 }}">
                Nastƒôpny tydzie≈Ñ ¬ª
            </a>
        </div>
    </div>

    <table class="calendar-table">
        <thead>
            <tr>
                <th>Pon</th>
                <th>Wt</th>
                <th>≈ör</th>
                <th>Cz</th>
                <th>Pt</th>
                <th>Sob</th>
                <th>Nd</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                {% for day, availabilities in availabilities_by_day_items %}
                <td>
                    <div class="cell-content">
                        <div class="calendar-day">
                            {{ day|date:"d" }}
                        </div>
                        
                        {% if availabilities %}
                            {% for info in availabilities %}
                            <div class="availability-item">
                                <div class="availability-title">
                                    {% if info.availability.title %}
                                        {{ info.availability.title }}
                                    {% else %}
                                        Dostƒôpno≈õƒá
                                    {% endif %}
                                    <a href="{% url 'delete_availability' info.availability.id %}" 
                                       class="btn-outline-danger"
                                       title="Usu≈Ñ dostƒôpno≈õƒá" 
                                       onclick="return confirm('Czy na pewno chcesz usunƒÖƒá tƒô dostƒôpno≈õƒá?')"
                                       style="float: right; color: #dc3545; text-decoration: none;">
                                        üóëÔ∏è
                                    </a>
                                </div>
                                <div class="availability-time">
                                    {{ info.availability.start_time|time:"H:i" }} - {{ info.availability.end_time|time:"H:i" }}
                                </div>

                                <!-- Zarezerwowane wizyty z szczeg√≥≈Çami -->
                                {% if info.bookings %}
                                    <div class="busy-slots">
                                        <div class="busy-slots-label">Zarezerwowane wizyty:</div>
                                        {% for booking in info.bookings %}
                                        <div class="booking-detail" style="margin: 4px 0; padding: 4px; background: rgba(220,53,69,0.1); border-radius: 3px;">
                                            <div style="display: flex; justify-content: between; align-items: center;">
                                                <div style="flex-grow: 1;">
                                                    <strong>{{ booking.service_type.name }}</strong><br>
                                                    <small>{{ booking.start_datetime|time:"H:i" }}-{{ booking.end_datetime|time:"H:i" }}</small><br>
                                                    <small>{{ booking.user.username }}</small>
                                                    {% if booking.client_phone %}
                                                        <br><small>üìû {{ booking.client_phone }}</small>
                                                    {% endif %}
                                                    {% if booking.client_note %}
                                                        <br><small>üí¨ {{ booking.client_note }}</small>
                                                    {% endif %}
                                                </div>
                                                <div style="margin-left: 8px;">
                                                    <a href="{% url 'cancel_calendar_booking' booking.id %}" 
                                                       title="Anuluj wizytƒô"
                                                       style="color: #dc3545; text-decoration: none; font-size: 12px;"
                                                       onclick="return confirm('Czy na pewno chcesz anulowaƒá tƒô wizytƒô?')">
                                                        ‚ùå
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                Przycisk rezerwacji
                                <div class="booking-actions">
                                    <a href="{% url 'book_availability' info.availability.id %}" 
                                       class="book-link available">
                                        üìÖ Dodaj wizyte
                                    </a>
                                </div> 
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-availability">
                                Brak dostƒôpno≈õci
                            </div>
                        {% endif %}
                    </div>
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>

    <div class="share-section">
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h4>Udostƒôpnij kalendarz</h4>
                <p>Udostƒôpnij sw√≥j kalendarz innym, kopiujƒÖc poni≈ºszy adres:</p>
                <div class="input-group">
                    <input type="text" 
                           class="form-control share-input" 
                           readonly 
                           value="{{ public_calendar_url }}"
                           id="calendar-url">
                    <button class="btn btn-outline-secondary copy-btn" 
                            type="button" 
                            onclick="copyToClipboard()">
                        Kopiuj
                    </button>
                </div>
            </div>

            <div style="flex: 1;">
                <h4>Twoja dostƒôpno≈õƒá w tym tygodniu:</h4>
                <ul class="ul_week">
                    {% for day, availabilities in availabilities_by_day_items %}
                        {% for info in availabilities %}
                        <li style="margin-bottom: 8px;">
                            {{ day|date:"d.m.Y" }}: {{ info.availability.start_time }} - {{ info.availability.end_time }}
                            <a href="{% url 'delete_availability' info.availability.id %}" 
                               class="btn btn-sm btn-outline-danger"
                               style="margin-left: 8px; font-size: 12px; padding: 2px 6px;"
                               onclick="return confirm('Czy na pewno chcesz usunƒÖƒá tƒô dostƒôpno≈õƒá?')">
                                üóëÔ∏è
                            </a>
                        </li>
                        {% endfor %}
                    {% empty %}
                    <li>Brak dostƒôpno≈õci</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard() {
    const input = document.getElementById('calendar-url');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'Skopiowano!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>

{% endblock %}