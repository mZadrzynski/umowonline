{% extends "myschedule/calendar_sidemenu.html" %}
{% block title %}Kalendarz tygodniowy{% endblock %}
{% block calendar %}
{% load static %}

<h2>Kalendarz tygodniowy u≈ºytkownika {{ request.user.username }}</h2>

<div class="row mb-3">
    <div class="col-md-12 text-center">
        <a href="?week={{ week_offset|add:-1 }}" class="btn btn-outline-primary">
            Poprzedni tydzie≈Ñ
        </a>
        |
        <a href="?week={{ week_offset|add:1 }}" class="btn btn-outline-primary">
            Nastƒôpny tydzie≈Ñ
        </a>
    </div>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Pon</th>
            <th>Wt</th>
            <th>≈ör</th>
            <th>Cz</th>
            <th>Pt</th>
            <th>Sob</th>
            <th>Nd</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            {% for day, availabilities in availabilities_by_day_items %}
            <td class="align-top" style="min-height: 200px;">
                <div class="fw-bold text-center mb-2">
                    {{ day|date:"d-m-Y" }}
                </div>
                
                {% if availabilities %}
                    {% for info in availabilities %}
                    <div class="border p-2 mb-2">
                        <!-- Nag≈Ç√≥wek dostƒôpno≈õci -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                {% if info.availability.title %}
                                    <strong>{{ info.availability.title }}</strong><br>
                                {% endif %}
                                <small>
                                    {{ info.availability.start_time|time:"H:i" }} - {{ info.availability.end_time|time:"H:i" }}
                                </small>
                            </div>
                            <div>
                                <!-- Przycisk usuwania dostƒôpno≈õci -->
                                <a href="{% url 'delete_availability' info.availability.id %}" 
                                   class="btn btn-sm btn-outline-danger"
                                   title="Usu≈Ñ dostƒôpno≈õƒá" 
                                   onclick="return confirm('Czy na pewno chcesz usunƒÖƒá tƒô dostƒôpno≈õƒá?')">
                                    üóëÔ∏è
                                </a>
                            </div>
                        </div>

                        <!-- Zarezerwowane wizyty -->
                        {% if info.busy_slots %}
                            <div class="alert alert-warning p-2 mb-2">
                                <strong>Zarezerwowane wizyty:</strong>
                                {% for booking in info.bookings %}
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <small>
                                        {{ booking.start_datetime|time:"H:i" }}-{{ booking.end_datetime|time:"H:i" }}
                                        ({{ booking.user.username }})
                                    </small>
                                    <a href="{% url 'cancel_calendar_booking' booking.id %}" 
                                       class="btn btn-xs btn-outline-danger"
                                       title="Anuluj wizytƒô"
                                       onclick="return confirm('Czy na pewno chcesz anulowaƒá tƒô wizytƒô?')">
                                        ‚ùå
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Przycisk rezerwacji -->
                        <div class="d-grid">
                            <a href="{% url 'book_availability' info.availability.id %}" 
                               class="btn btn-sm {% if info.busy_slots %}btn-outline-success{% else %}btn-success{% endif %}">
                                {% if info.busy_slots %}
                                    üìÖ Zarezerwuj pozosta≈Çy czas
                                {% else %}
                                    ‚úÖ Zarezerwuj
                                {% endif %}
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-3">
                        Brak dostƒôpno≈õci
                    </div>
                {% endif %}
            </td>
            {% endfor %}
        </tr>
    </tbody>
</table>

<div class="row mt-4">
    <div class="col-md-6">
        <h4>Udostƒôpnij kalendarz</h4>
        <p>Udostƒôpnij sw√≥j kalendarz innym, kopiujƒÖc poni≈ºszy adres:</p>
        <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   readonly 
                   value="{{ public_calendar_url }}"
                   id="calendar-url">
            <button class="btn btn-outline-secondary" 
                    type="button" 
                    onclick="copyToClipboard()">
                Kopiuj
            </button>
        </div>
    </div>

    <div class="col-md-6">
        <h4>Twoja dostƒôpno≈õƒá w tym tygodniu:</h4>
        <ul>
            {% for day, availabilities in availabilities_by_day_items %}
                {% for info in availabilities %}
                <li>
                    {{ day|date:"d.m.Y" }}: {{ info.availability.start_time }} - {{ info.availability.end_time }}
                    <a href="{% url 'delete_availability' info.availability.id %}" 
                       class="btn btn-sm btn-outline-danger ms-2"
                       onclick="return confirm('Czy na pewno chcesz usunƒÖƒá tƒô dostƒôpno≈õƒá?')">
                        üóëÔ∏è
                    </a>
                </li>
                {% endfor %}
            {% empty %}
            <li>Brak dostƒôpno≈õci</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
function copyToClipboard() {
    const input = document.getElementById('calendar-url');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'Skopiowano!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>

{% endblock %}