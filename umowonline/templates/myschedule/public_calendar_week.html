{% extends "base.html" %}
{% block title %}Kalendarz tygodniowy – {{ calendar_owner.username }}{% endblock %}
{% block content %}
{% load static %}
<head>
    <link rel="stylesheet" href="{% static 'css/calendar.css' %}">
</head>
<div class="container">
    <h1 class="mt-4 mb-4">Kalendarz tygodniowy użytkownika {{ calendar_owner.username }}</h1>
    <div class="calendar-container">
    <div">
        <div class="month-nav">
            <a href="?week={{ week_offset|add:-1 }}">
                « Poprzedni tydzień
            </a>
            <span>{{ selected_week|date:"d.m.Y" }}</span>
            <a href="?week={{ week_offset|add:1 }}">
                Następny tydzień »
            </a>
        </div>
    </div>
    <table class="calendar-table">
        <thead>
            <tr>
                <th>Pon</th>
                <th>Wt</th>
                <th>Śr</th>
                <th>Cz</th>
                <th>Pt</th>
                <th>Sob</th>
                <th>Nd</th>
            </tr>
        </thead>
            <tbody>
                <tr>
                    {% for day, availabilities in availabilities_by_day_items %}
                    <td class="calendar-cell">
                        <div class="day-header">{{ day|date:"d" }}</div>
                        
                        {% if availabilities %}
                            {% for info in availabilities %}
                            <div class="mb-2 p-2 border rounded-sm">
                                
                                {% if info.availability.title %}
                                <div class="text-muted small mb-1">{{ info.availability.title }}</div>
                                {% endif %}
                                
                                <!-- Pokaż wolne przedziały zamiast całego czasu dostępności -->
                                {% if info.free_slots %}
                                <div>
                                    Dostępne:
                                    {% for start, end in info.free_slots %}
                                    <div>{{ start }}–{{ end }}</div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-muted">Brak wolnych terminów</div>
                                {% endif %}
                                

                                <!-- NOWY ŁADNY PRZYCISK -->
                                <div class="booking-button-container">
                                    <a href="{% url 'book_availability' info.availability.id %}" 
                                       class="book-link-new available">
                                            📅 Zarezerwuj wizytę
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-availability">
                                Brak dostępności
                            </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>
</div>
<script>
function updateAvailableTimes(serviceTypeId) {
    if (!serviceTypeId) return;
    
    // AJAX call to get available times for selected service
    fetch(`/myschedule/get-available-times/${availability.id}/${serviceTypeId}/`)
        .then(response => response.json())
        .then(data => {
            const startTimeSelect = document.querySelector('#id_start_time');
            startTimeSelect.innerHTML = '';
            
            if (data.times.length > 0) {
                data.times.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time[0];
                    option.textContent = time[1];
                    startTimeSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Brak dostępnych godzin';
                startTimeSelect.appendChild(option);
            }
        });
}
</script>
{% endblock %}